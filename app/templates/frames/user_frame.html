<!-- Bootstrap CSS -->
{% block resource %}
<style>
    .action-column {
        min-width: 160px;
    }
    .table-container {
        margin-top: 20px;
    }
</style>
{% endblock %}

<div class="container mt-4">
    <!-- 操作栏 -->
    <div class="row mb-3">
        <div class="col-md-6">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal">
                <i class="bi bi-plus-lg"></i> 添加用户
            </button>
        </div>
        <div class="col-md-6">
            <input type="text" class="form-control" id="searchInput" placeholder="搜索用户...">
        </div>
    </div>

    <!-- 用户表格 -->
    <div class="table-container">
        <table class="table table-hover table-bordered">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>姓名</th>
                <th>邮箱</th>
                <th>角色</th>
                <th class="action-column">操作</th>
            </tr>
            </thead>
            <tbody id="userTableBody">
            </tbody>
        </table>
    </div>
    <div id="foot-paginate"></div>
</div>

{%block javascript %}

<link href="{{ url_for('static', filename='css/local/page.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/pagination.js') }}"></script>
<script>
    window.page = new Pagination({
        url:"/author/list_users",
        params:{
            key: $("#searchInput").val(),
            page:1,
            per_page:10
        },
        container:"#foot-paginate",
        callback:function(res){
            renderUsers(res);
        }
    });
    function loadUsers(){
      // 清空现有内容
        $('#userTableBody').empty().append('<tr><td colspan="5">加载中...</td></tr>');
        window.page.options.params.key = $("#searchInput").val();
        window.page.options.params.page = 1;
        window.page.options.params.per_page = 10;
        window.page.loadData();
    }

    function renderUsers(res){
        // 清空加载状态
          $('#userTableBody').empty();
          console.log(res);

          // 动态生成表格行
          res.forEach(function(user) {
            const rowHtml = `
              <tr data-userid="${user.id}">
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.role}</td>
                <td>
                  <button class="btn btn-sm btn-warning edit-btn">编辑</button>
                  <button class="btn btn-sm btn-danger delete-btn">删除</button>
                </td>
              </tr>
            `;
            $('#userTableBody').append(rowHtml);
          });

          // 若无数据时显示提示
          if(res.length === 0) {
            $('#userTableBody').html('<tr><td colspan="5">暂无用户数据</td></tr>');
          }
    }

    async function hashPassword(password, salt) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password + salt);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    $(document).ready(function() {
        let currentEditId = null;

        // 表单提交处理
        $('#userForm').submit(function(e) {
            e.preventDefault();
            const formData = {
                id: $('input[name="user_id"]').val(),
                username: $('input[name="username"]').val(),
                name: $('input[name="name"]').val(),
                email: $('input[name="email"]').val(),
                role: $('select[name="role"]').val()
            };
            $.ajax({
                url:"/author/add_user",
                type:"POST",
                data:formData,
                success:function(res){
                    loadUsers();
                }
            });
            $('#userModal').modal('hide');
            resetForm();
        });

        // 删除用户
        $('#userTableBody').on('click', '.delete-btn', function() {
            const row = $(this).closest('tr');
            window.CustomDialog.confirm(
                '确定要删除该用户吗？',
                () => {
                    $.ajax({
                        url:"/move_to_trash/users/" + row.find('td:eq(0)').text(),
                        type:"POST",
                        success:function(res){
                            if(res.success){
                                loadUsers();
                            }
                        }
                    })
                },
                () => { /* 取消操作 */ }
            );

        });

        // 编辑用户
        $('#userTableBody').on('click', '.edit-btn', function() {
            const row = $(this).closest('tr');
            currentEditId = row.data('id');

            $('#modalTitle').text('编辑用户');
            $('input[name="user_id"]').val(row.find('td:eq(0)').text());
            $('input[name="username"]').val(row.find('td:eq(1)').text());
            $('input[name="name"]').val(row.find('td:eq(2)').text());
            $('input[name="email"]').val(row.find('td:eq(3)').text());
            $('select[name="role"]').val(row.find('td:eq(4)').text());

            $('#userModal').modal('show');
        });

        // 搜索功能
        $('#searchInput').on('input', function() {
            window.page.options.params.key = $(this).val().toLowerCase();
            loadUsers();
        });

        // 重置表单
        function resetForm() {
            currentEditId = null;
            $('#modalTitle').text('添加用户');
            $('#userForm')[0].reset();
        }

        // 模态框关闭时重置
        $('#userModal').on('hidden.bs.modal', resetForm);
    });
</script>

{% endblock %}
